# TazUO 国际化 (i18n) 文档

## 概述

本文档记录了TazUO客户端的国际化实现，包括中文汉化的完整流程和技术细节。

## 语言系统架构

### 1. 双重语言系统

TazUO使用两套独立的语言系统：

#### 1.1 .NET资源文件系统 (.resx)
- **位置**: `src/ClassicUO.Client/Resources/`
- **文件**:
  - `ResGumps.resx` / `ResGumps.zh-CN.resx` (界面文本)
  - `ResGeneral.resx` / `ResGeneral.zh-CN.resx` (通用文本)
  - `ResErrorMessages.resx` / `ResErrorMessages.zh-CN.resx` (错误消息)
- **编译输出**: `bin/Debug/net9.0/win-x64/zh-CN/TazUO.resources.dll`
- **用途**: 主要用于简单的UI文本和错误消息

#### 1.2 JSON语言文件系统
- **位置**: `Data/Language.zh-CN.json`
- **类定义**: `src/ClassicUO.Client/Configuration/Language.cs`
- **用途**: 用于复杂的UI界面（如选项菜单）的所有文本

### 2. 语言加载流程

```
启动 → LanguageManager.Initialize()
     ↓
     检测系统语言 (zh-CN)
     ↓
     设置 CultureInfo (CurrentCulture, CurrentUICulture, DefaultThreadCurrentCulture)
     ↓
     设置资源文件Culture (ResGumps.Culture, ResGeneral.Culture, ResErrorMessages.Culture)
     ↓
     Language.Load() → 按优先级加载JSON文件:
                      1. Data/Language.zh-CN.json (特定文化)
                      2. Data/Language.zh.json (两字母代码)
                      3. Data/Language.json (默认英文)
```

### 3. 语言文件加载优先级

`Language.cs` 中的 `ResolveLanguageFilePathForLoad()` 方法实现了以下加载顺序：

1. **特定文化文件**: `Data/Language.{CurrentUICulture.Name}.json` (例如: `Language.zh-CN.json`)
2. **两字母代码文件**: `Data/Language.{TwoLetterISOLanguageName}.json` (例如: `Language.zh.json`)
3. **默认文件**: `Data/Language.json` (英文)

## 字体支持

### 中文字体回退机制

**文件**: `src/ClassicUO.Assets/TrueTypeLoader.cs`

#### 实现特性：
1. **支持多种字体格式**: .ttf 和 .otf
2. **自动检测中文字体**: 
   - 通过文件名关键词 (noto, source, chinese, sc, hans, cjk)
   - 通过文件大小 (>1MB)
3. **字体回退**: 为所有英文字体自动添加中文字体作为回退
4. **加载顺序**:
   - 先加载嵌入字体 (`src/ClassicUO.Assets/fonts/*.ttf`)
   - 再加载运行时字体 (`Fonts/*.ttf` 和 `Fonts/*.otf`)

#### 推荐字体：
- **Noto Sans SC** (Google开源，3-4MB)
- **思源黑体 Source Han Sans** (Adobe+Google，6-7MB)
- 许可证: SIL Open Font License 1.1 (OFL) - 可免费商用

## 已翻译的界面部分

### 1. 主界面
- ✅ 顶部搜索框 ("Search" → "搜索")
- ✅ 所有左侧菜单按钮

### 2. 常规设置页面
- ✅ 所有设置项和选项

### 3. 声音设置页面
- ✅ 所有设置项

### 4. 视频设置页面
- ✅ 游戏窗口设置
- ✅ 缩放设置
- ✅ 光照设置
- ✅ 阴影设置

### 5. 宏页面
- ✅ "新建宏" / "删除宏" 按钮
- ✅ "上移" / "下移" 按钮

### 6. 工具提示页面
- ✅ 所有设置项

### 7. 聊天设置页面
- ✅ 所有设置项和颜色选项

### 8. 战斗与法术页面
- ✅ 所有设置项

### 9. 计数器页面
- ✅ 所有设置项

### 10. 信息栏页面
- ✅ 所有设置项

### 11. 容器页面
- ✅ 所有设置项

### 12. 实验性功能页面
- ✅ 所有设置项

### 13. 名牌选项页面
- ✅ "新条目" / "删除条目" 按钮
- ✅ 下拉菜单选项:
  - "全部" (All)
  - "仅移动对象" (Mobiles only)
  - "仅物品" (Items only)
  - "仅移动对象和尸体" (Mobiles & Corpses only)
- ✅ 所有复选框选项 (30+项)

### 14. 冷却条页面
- ✅ 所有设置项

### 15. TazUO专属页面
- ✅ 网格容器设置
- ✅ 日志设置
- ✅ 现代纸娃娃设置
- ✅ 名牌设置
- ✅ 移动对象设置
- ✅ 杂项设置
- ✅ 工具提示设置
- ✅ 字体设置
- ✅ 手柄设置
- ✅ 设置转移

### 16. 热键页面
- ✅ 页面描述
- ✅ 所有27个热键描述:
  - 移动界面
  - 分离锚定的界面
  - 显示锁定按钮
  - 按住以关闭锚定的界面
  - 锁定界面
  - 显示界面锁定图标
  - 调整界面不透明度
  - 网格容器相关操作 (4项)
  - 从计数栏移除物品
  - 点击跟随
  - 激活聊天
  - 分割物品堆叠
  - 显示名牌
  - 寻路
  - 购买/出售所有
  - 物品拖动锁定
  - 缩放窗口
  - 滚动消息
  - 自动启动xml界面
  - 世界地图操作 (2项)
  - 截图界面

### 17. 可见图层页面
- ✅ 页面描述和设置
- ✅ 所有装备部位名称 (19项):
  - 单手武器 (OneHanded)
  - 双手武器 (TwoHanded)
  - 鞋子 (Shoes)
  - 裤子 (Pants)
  - 衬衫 (Shirt)
  - 头盔 (Helmet)
  - 手套 (Gloves)
  - 戒指 (Ring)
  - 项链 (Necklace)
  - 腰带 (Waist)
  - 躯干 (Torso)
  - 手镯 (Bracelet)
  - 束腰外衣 (Tunic)
  - 耳环 (Earrings)
  - 护臂 (Arms)
  - 斗篷 (Cloak)
  - 长袍 (Robe)
  - 裙子 (Skirt)
  - 护腿 (Legs)

## 关键代码文件

### 核心文件
1. **src/ClassicUO.Client/Configuration/LanguageManager.cs**
   - 语言管理器
   - 自动检测系统语言
   - 设置Culture和资源文件Culture

2. **src/ClassicUO.Client/Configuration/Language.cs**
   - JSON语言文件的类定义
   - 语言加载逻辑
   - 包含所有UI文本的类结构

3. **src/ClassicUO.Client/Main.cs**
   - 在加载设置前提前设置Culture
   - 调用LanguageManager.Initialize()

4. **src/ClassicUO.Assets/TrueTypeLoader.cs**
   - 字体加载器
   - 中文字体回退机制

### UI文件
1. **src/ClassicUO.Client/Game/UI/Gumps/BaseOptionsGump.cs**
   - 基础选项界面
   - 顶部搜索框

2. **src/ClassicUO.Client/Game/UI/Gumps/ModernOptionsGump.cs**
   - 现代选项界面
   - 所有设置页面的实现

3. **src/ClassicUO.Client/Game/Managers/NameOverHeadManager.cs**
   - 名牌管理器
   - 默认名牌选项的创建

## 翻译方法

### 1. 添加新的翻译字段

#### 步骤 1: 在Language.cs中添加字段
```csharp
public class SomeLanguageClass
{
    public string NewField { get; set; } = "English Text";
}
```

#### 步骤 2: 在Language.zh-CN.json中添加翻译
```json
{
  "GetModernOptionsGumpLanguage": {
    "SomeLanguageClass": {
      "NewField": "中文文本"
    }
  }
}
```

#### 步骤 3: 在代码中使用
```csharp
// 使用Language.Instance访问
string text = Language.Instance.GetModernOptionsGumpLanguage.SomeLanguageClass.NewField;
```

### 2. 翻译函数模式

对于需要动态翻译的内容（如枚举值），使用翻译函数：

```csharp
public string TranslateOptionName(string englishName)
{
    return englishName switch
    {
        "All" => All,
        "Mobiles only" => MobilesOnly,
        _ => englishName
    };
}
```

## 编译和部署

### 编译
```bash
dotnet build src/ClassicUO.Client/ClassicUO.Client.csproj -c Debug
```

### 输出文件
- **主程序**: `bin/Debug/net9.0/win-x64/TazUO.dll`
- **中文资源**: `bin/Debug/net9.0/win-x64/zh-CN/TazUO.resources.dll`
- **语言文件**: `bin/Debug/net9.0/win-x64/Data/Language.zh-CN.json`
- **字体文件**: `bin/Debug/net9.0/win-x64/Fonts/NotoSansSC-Regular.otf`

## 测试

### 验证语言加载
运行游戏后，检查控制台输出：
```
[Early Init] Set culture to zh-CN before loading settings
=== LanguageManager.Initialize() START ===
Detected language: zh-CN
Before - CurrentUICulture: zh-CN
After - CurrentUICulture: zh-CN
After - ResGumps.Culture: zh-CN
Testing resource: ResGumps.Add = '添加'
Loading language file: Data/Language.zh-CN.json
✓ Language loaded successfully from 'Data/Language.zh-CN.json'
```

### 验证字体加载
检查控制台输出：
```
Loading runtime font: NotoSansSC-Regular
Found Chinese fallback font: NotoSansSC-Regular
Added Chinese fallback font to Roboto-Regular
```

## 已知问题和限制

1. **热键页面的热键组合**: 热键组合本身（如"ALT"、"CTRL"）未翻译，保持英文以便识别
2. **某些硬编码文本**: 部分错误消息和调试信息仍为英文
3. **动态生成的文本**: 某些运行时生成的文本可能未翻译

## 未来改进

1. 添加更多语言支持（日语、韩语、法语等）
2. 实现运行时语言切换（无需重启）
3. 添加语言文件编辑器
4. 完善翻译覆盖率
5. 添加翻译质量检查工具

## 贡献指南

### 添加新语言

1. 创建新的语言文件: `Data/Language.{culture}.json`
2. 复制`Language.zh-CN.json`作为模板
3. 翻译所有文本字段
4. 创建对应的.resx文件: `ResGumps.{culture}.resx`
5. 测试并提交

### 改进现有翻译

1. 编辑`Language.zh-CN.json`或对应的.resx文件
2. 确保JSON格式正确
3. 测试翻译效果
4. 提交更改

## 技术细节

### Culture设置时机
Culture必须在以下时机设置：
1. **Main.cs启动时**: 在加载Settings之前
2. **LanguageManager.Initialize()**: 在Settings加载之后
3. **资源文件Culture**: 在任何资源访问之前

### 字符编码
- 所有JSON文件使用UTF-8编码（无BOM）
- 自动检测和转换GBK编码的文件

### 资源文件编译
- .resx文件在编译时自动生成.resources.dll
- 中文资源DLL位于zh-CN子目录
- ResourceManager根据CurrentUICulture自动选择正确的资源

## 参考资料

- [.NET Globalization and Localization](https://docs.microsoft.com/en-us/dotnet/core/extensions/globalization-and-localization)
- [SIL Open Font License](https://scripts.sil.org/OFL)
- [Noto Fonts](https://fonts.google.com/noto)
- [FontStashSharp](https://github.com/FontStashSharp/FontStashSharp)

## 版本历史

### v1.0 (2024-11-08)
- ✅ 完成中文汉化
- ✅ 实现字体回退机制
- ✅ 添加语言自动检测
- ✅ 翻译所有主要UI界面
- ✅ 支持.otf字体格式

---

**维护者**: TazUO开发团队  
**最后更新**: 2024-11-08
