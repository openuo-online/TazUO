# 窗体大小与UI缩放智能优化方案

## 问题描述

在高分辨率显示器（如4K、5K）上，如果使用固定的窗体大小（如800x600），窗体会显得非常小。更重要的是，即使窗体大小合适，UI元素、字体、图标等如果不进行缩放，在高DPI显示器上也会显得非常小，用户体验很差。

需要一个能够根据不同分辨率显示器自动调整窗体初始大小**和UI全局缩放**的完整方案。

## 解决方案

### 核心特性

1. **自动DPI感知**：检测显示器的DPI缩放比例
2. **智能尺寸计算**：根据屏幕分辨率和DPI自动计算合理的窗体大小
3. **全局UI缩放**：自动应用全局缩放，确保UI元素、字体、图标等在高DPI显示器上大小合适
4. **用户设置优先**：如果用户已保存窗体大小或手动调整缩放，优先使用用户设置
5. **多分辨率支持**：完美支持从1080P到5K+的各种分辨率

### 支持的分辨率范围

#### 登录界面

| 分辨率类型 | 示例分辨率 | DPI缩放 | 登录窗体大小 | UI缩放 | 视觉效果 |
|-----------|-----------|---------|-------------|--------|---------|
| 1080P     | 1920x1080 | 1.0x    | 640x480     | 1.0x   | 640x480 |
| 2K        | 2560x1440 | 1.5x    | 960x720     | 1.5x   | 640x480 |
| 4K        | 3840x2160 | 2.0x    | 1280x960    | 2.0x   | 640x480 |
| 5K        | 5120x2880 | 2.5x    | 1600x1200   | 2.5x   | 640x480 |

#### 游戏内

| 分辨率类型 | 示例分辨率 | DPI缩放 | 游戏窗体大小 | UI全局缩放 |
|-----------|-----------|---------|-------------|-----------|
| 1080P     | 1920x1080 | 1.0x    | 1280x960    | 1.0x (不缩放) |
| 2K        | 2560x1440 | 1.5x    | 1400x1050   | 1.5x |
| 4K        | 3840x2160 | 2.0x    | 1600x1200   | 2.0x |
| 5K        | 5120x2880 | 2.5x    | 1600x1200   | 2.5x |

### 计算逻辑

#### 1. DPI检测（启动时）

- 获取主显示器的分辨率
- 尝试获取DPI缩放比例（通过SDL3 API）
- 如果无法获取DPI，根据分辨率估算：
  - 5K+ (≥14745600像素) → 2.5x
  - 4K (≥8294400像素) → 2.0x
  - 2K (≥3686400像素) → 1.5x
  - 1080P及以下 → 1.0x
- **设置全局DPI缩放因子**：`CUOEnviroment.DPIScaleFactor`

#### 2. 登录界面窗体大小（LoginScene）

**策略：固定基准大小 × DPI缩放**

```csharp
int loginWidth = (int)(640 * CUOEnviroment.DPIScaleFactor);
int loginHeight = (int)(480 * CUOEnviroment.DPIScaleFactor);
```

- **基准大小**：640x480（登录界面原始设计尺寸）
- **实际窗体**：640 × DPI缩放
- **UI缩放**：应用DPI缩放
- **视觉效果**：始终看起来像640x480，无黑边

**示例：**
- 1080P: 窗体640x480，UI缩放1.0x → 视觉640x480
- 4K: 窗体1280x960，UI缩放2.0x → 视觉640x480

#### 3. 游戏内窗体大小（GameScene）

**策略：根据屏幕分辨率选择合适尺寸**

- 优先检查是否有用户保存的窗体大小设置
- 如果有，直接使用用户设置
- 否则，根据屏幕分辨率自动计算：
  - **4K或更高** (≥3840宽度)：1600x1200
  - **2K** (≥2560宽度)：1400x1050
  - **1080P或更低**：1280x960
- 限制最大尺寸：不超过屏幕的75%
- 保证最小尺寸：至少1024x768

#### 4. UI全局缩放应用（Profile加载时）

- 在Profile加载时自动检查DPI缩放因子
- 如果DPI > 1.0且用户未手动配置缩放：
  - 自动启用 `GlobalScaling = true`
  - 设置 `GlobalScale = DPI缩放因子`
- 如果用户已手动调整过缩放，保留用户设置

#### 5. 安全边界

- 窗体大小不超过屏幕的75-80%，为任务栏和边框留出空间
- 确保窗体不会太小（最小1024x768）
- 确保窗体不会超出屏幕范围

### 代码实现

#### GameController.cs - 窗体大小初始化

1. **InitializeWindowSize()**
   - 在GameController构造函数中调用
   - 负责初始化窗体大小的主逻辑
   - **设置全局DPI缩放因子**：`CUOEnviroment.DPIScaleFactor`

2. **GetDisplayDpiScale()**
   - 获取显示器的DPI缩放比例
   - 支持SDL3的原生DPI检测
   - 提供基于分辨率的估算后备方案

3. **CalculateOptimalWindowSize()**
   - 根据屏幕分辨率和DPI计算最佳窗体大小
   - 应用各种限制和边界检查
   - 保持合理的宽高比

4. **SetFallbackWindowSize()**
   - 当无法获取显示器信息时的后备方案
   - 使用1280x960作为默认尺寸

#### ProfileManager.cs - UI全局缩放

1. **ApplyAutoDPIScaling()**
   - 在Profile加载时自动调用
   - 检查 `CUOEnviroment.DPIScaleFactor`
   - 如果DPI > 1.0且用户未手动配置：
     - 自动启用 `profile.GlobalScaling = true`
     - 设置 `profile.GlobalScale = DPIScaleFactor`
   - 保护用户手动配置的设置不被覆盖

#### LoginScene.cs - 登录界面窗体

1. **Load() 方法**
   - 计算登录窗体大小：`640 × DPI缩放`
   - 调用 `SetWindowSize()` 设置窗体
   - 确保登录界面始终视觉上是640x480

#### UIManager.cs - UI缩放控制

1. **Draw() 方法**
   - **游戏内**：使用 `ProfileManager.CurrentProfile.GlobalScale` 进行UI缩放
   - **登录界面**：使用 `CUOEnviroment.DPIScaleFactor` 进行UI缩放
   - 确保登录界面和游戏内UI都清晰可见

#### Mouse.cs - 鼠标坐标转换

1. **Update() 方法**
   - **游戏内**：根据 `Profile.GlobalScale` 转换鼠标坐标
   - **登录界面**：根据 `CUOEnviroment.DPIScaleFactor` 转换鼠标坐标
   - 确保鼠标点击在缩放后的UI上准确

### 用户体验

#### 首次启动流程

**1080P显示器：**
- 检测到DPI = 1.0
- 窗体大小：1280x960 → 保存到 `settings.json`
- **登录界面**：窗体大小合适，UI正常显示
- 首次登录角色时，UI缩放：1.0x（不启用缩放）→ 保存到 `profile.json`
- 一切正常，无需调整

**4K显示器：**
- 检测到DPI = 2.0
- **登录界面**：
  - 窗体大小：1280x960（640 × 2.0）
  - UI缩放：2.0x
  - 视觉效果：看起来像640x480，无黑边
- 首次登录角色时：
  - 游戏窗体：1600x1200 → 保存到 `settings.json`
  - UI缩放：2.0x（自动启用）→ 保存到 `profile.json`
- 游戏内的字体、图标、UI元素都会自动放大2倍
- 显示效果清晰舒适

**5K显示器：**
- 检测到DPI = 2.5
- 窗体大小：3200x2400 → **立即保存到 `settings.json`**（窗体本身放大2.5倍）
- **登录界面**：窗体已经足够大，UI元素正常显示，无需额外缩放
- 首次登录角色时，UI缩放：2.5x（自动启用）→ 保存到 `profile.json`
- 完美适配超高分辨率显示器

#### 后续启动

**窗体大小：**
- 从 `settings.json` 读取保存的大小
- 用户调整窗体大小后，退出时自动保存
- 所有角色共享同一个窗体大小

**UI缩放：**
- 从角色的 `profile.json` 读取保存的缩放设置
- 用户可以在游戏内选项中手动调整（Modern Options -> Scaling）
- 手动调整后立即保存到该角色的 `profile.json`
- 不同角色可以有不同的缩放设置

#### 多显示器支持

- 自动检测主显示器
- 在不同显示器间移动时保持合理尺寸
- 如果更换显示器（如从1080P换到4K），删除 `settings.json` 中的 `window_size` 即可重新自动计算

### 配置文件

#### settings.json（全局设置，所有角色共享）

窗体大小和位置保存在 `settings.json` 中：

```json
{
  "window_size": {
    "X": 2560,
    "Y": 1920
  },
  "window_position": {
    "X": 100,
    "Y": 100
  },
  "is_win_maximized": false
}
```

#### profile.json（每个角色独立设置）

UI全局缩放保存在每个角色的 `profile.json` 中：

```json
{
  "GlobalScaling": true,
  "GlobalScale": 2.0
}
```

这意味着：
- **窗体大小**是全局的，所有角色共享
- **UI缩放**是每个角色独立的，可以为不同角色设置不同的缩放比例

### 测试建议

1. **1080P显示器测试**：
   - 预期窗体大小：1280x960
   - 验证窗体不会太大

2. **2K显示器测试**：
   - 预期窗体大小：约1920x1440
   - 验证DPI缩放正确

3. **4K显示器测试**：
   - 预期窗体大小：约2560x1920
   - 验证窗体大小合适，不会太小

4. **5K显示器测试**：
   - 预期窗体大小：约3200x2400
   - 验证不会超出屏幕范围

5. **用户设置测试**：
   - 调整窗体大小后关闭
   - 重新启动验证大小被保存
   - 删除设置验证自动计算生效

### 优势

1. **自适应**：无需手动配置，自动适应各种显示器
2. **智能**：考虑DPI、分辨率、屏幕边界等多个因素
3. **灵活**：用户可以自由调整，调整后会被记住
4. **安全**：多重边界检查，确保窗体始终可见和可用
5. **兼容**：支持从1080P到5K+的所有常见分辨率
6. **全流程覆盖**：登录界面通过窗体大小适配，游戏内通过UI缩放适配
7. **可调节范围扩大**：UI缩放最大值从175%提升到200%
8. **避免UI溢出**：登录界面不应用UI缩放，避免元素超出窗体范围

### 日志输出

系统会输出详细的日志信息，方便调试：

**窗体初始化日志：**
```
[Trace] Display info - Resolution: 3840x2160, DPI Scale: 2.00
[Trace] Global UI scale factor set to: 2.00
[Trace] Initialized window size: 2560x1920
```

或者使用用户设置时：
```
[Trace] Display info - Resolution: 3840x2160, DPI Scale: 2.00
[Trace] Global UI scale factor set to: 2.00
[Trace] Using saved window size: 2560x1920
```

**Profile加载时的缩放日志：**
```
[Trace] Auto-enabled global scaling: 2.00x for high-DPI display
```

### 技术细节

#### 全局缩放的工作原理

**两层缩放策略：**

1. **窗体大小层面**（适用于所有阶段）：
   - 根据DPI自动调整窗体的物理大小
   - 在4K显示器上，窗体从1280x960放大到2560x1920
   - 登录界面和游戏内都受益于更大的窗体

2. **UI缩放层面**（仅游戏内）：
   - 使用矩阵变换实现UI元素的缩放
   - 只在游戏内应用，登录界面不需要
   
```csharp
// 在UIManager.Draw()中
if (InGame && ProfileManager.CurrentProfile != null && ProfileManager.CurrentProfile.GlobalScaling)
{
    // 游戏内使用Profile的缩放设置
    batcher.Begin(null, Matrix.CreateScale(ProfileManager.CurrentProfile.GlobalScale));
}
else
{
    // 登录界面不应用UI缩放，因为窗体大小已经根据DPI调整过了
    batcher.Begin();
}
```

**登录界面的特殊处理：**
- **窗体大小**：640 × DPI缩放（如4K下为1280x960）
- **UI缩放**：应用DPI缩放（2.0x）
- **视觉效果**：始终看起来像640x480
- **无黑边**：窗体大小和UI缩放完美匹配，UI刚好填满窗体

**为什么这样设计？**
- 登录界面的UI是固定设计（640x480）
- 通过窗体放大 + UI缩放，保持原始视觉比例
- 避免黑边和UI溢出问题

#### DPI缩放因子的传递

1. `GameController.InitializeWindowSize()` 检测DPI并设置 `CUOEnviroment.DPIScaleFactor`
2. `ProfileManager.Load()` 读取 `CUOEnviroment.DPIScaleFactor`
3. `ProfileManager.ApplyAutoDPIScaling()` 应用到 `Profile.GlobalScale`
4. 渲染时使用 `Profile.GlobalScale` 进行矩阵变换

#### 用户手动调整的保护

系统会检查用户是否手动调整过缩放：
- 如果 `GlobalScale` 不是默认值（1.5或1.0），认为用户已手动配置
- 用户手动配置的设置永远不会被自动覆盖
- 用户可以在游戏内选项中随时调整

## 总结

这个完整方案通过智能的两阶段策略解决了高分辨率显示器的问题：

### 登录界面策略
- **窗体大小** = 640 × DPI缩放
- **UI缩放** = DPI缩放
- **视觉效果** = 始终640x480，无黑边
- **完美适配**：从1080P到5K+所有分辨率

### 游戏内策略
- **窗体大小**：根据屏幕分辨率智能计算
- **UI缩放**：自动应用DPI缩放
- **用户可调**：支持手动调整（最大200%）

### 核心优势

1. **统一的DPI检测**：一次检测，全局使用
2. **分阶段适配**：登录界面和游戏内采用不同但协调的策略
3. **无黑边体验**：登录界面UI完美填充窗体
4. **清晰可读**：游戏内UI自动放大，字体图标清晰
5. **用户友好**：自动配置 + 手动调整，灵活性强

在4K显示器上：
- ✅ 登录界面：1280x960窗体 + 2.0x UI缩放 = 视觉640x480
- ✅ 游戏内：1600x1200窗体 + 2.0x UI缩放 = 清晰舒适
- ✅ 无需手动配置，开箱即用
- ✅ 支持用户自定义调整

完美解决了"窗体虽大但内容很小"和"登录界面有黑边"的问题！
